---
- hosts: sclab
  remote_user: stevenokm
  become: yes
  become_user: root
  become_method: sudo
  tasks:
    - name: download CUDA repo
      get_url:
      args:
        url: https://developer.download.nvidia.com/compute/cuda/repos/ubuntu1604/x86_64/cuda-repo-ubuntu1604_10.1.243-1_amd64.deb
        dest: /tmp/cuda-repo-ubuntu1604_10.1.243-1_amd64.deb
        checksum: "sha256:df3d387cfd1675c230a9364dfdddb478ff79cd693d19bf909c420c0ee89f8145"
      when: ansible_distribution == 'Ubuntu' and ansible_distribution_version == '16.04'

    - name: install CUDA repo
      apt:
      args:
        deb: /tmp/cuda-repo-ubuntu1604_10.1.243-1_amd64.deb
      when: ansible_distribution == 'Ubuntu' and ansible_distribution_version == '16.04'

    - name: setup CUDA repo
      apt_key:
        url: http://developer.download.nvidia.com/compute/cuda/repos/ubuntu1604/x86_64/7fa2af80.pub
      when: ansible_distribution == 'Ubuntu' and ansible_distribution_version == '16.04'

    - name: update apt
      apt: update_cache=yes

    - name: install CUDA driver
      apt:
        pkg: nvidia-modprobe=410.129-0ubuntu1 nvidia-settings=410.129-0ubuntu1 cuda-drivers=410.129-1
        state: present
      when: ansible_distribution == 'Ubuntu' and ansible_distribution_version == '16.04'

    - name: install CUDA 10.1
      apt:
        pkg: cuda-10-1
        state: present
      when: ansible_distribution == 'Ubuntu' and ansible_distribution_version == '16.04'

    - name: install CUDA 10.0
      apt:
        pkg: cuda-10-0
        state: present
      when: ansible_distribution == 'Ubuntu' and ansible_distribution_version == '16.04'

    - name: install CUDA 8.0
      apt:
        pkg: cuda-8-0
        state: present
      when: ansible_distribution == 'Ubuntu' and ansible_distribution_version == '16.04'

    - name: install CUDA 9.0
      apt:
        pkg: cuda-9-0
        state: present
      when: ansible_distribution == 'Ubuntu' and ansible_distribution_version == '16.04'

    - name: install CUDA 9.2
      apt:
        pkg: cuda-9-2
        state: present
      when: ansible_distribution == 'Ubuntu' and ansible_distribution_version == '16.04'

    - name: set default cuda device setting script
      copy:
        dest: "/etc/profile.d/cuda-default.sh"
        content: |
          export CUDA_VISIBLE_DEVICES="0"
          export CUDA_DEVICE_ORDER=PCI_BUS_ID

    - name: install environment modules
      apt:
        pkg: environment-modules
        state: present
      when: ansible_distribution == 'Ubuntu' and ansible_distribution_version == '16.04'

      #    - name: setup environment modules for cuda
      #      copy:
      #        src: "cuda"
      #        dest: "/usr/share/modules/modulefiles/"

